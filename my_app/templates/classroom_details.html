{% extends 'base.html' %}

{% block title %}Classroom Details - CodeQuest{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/leaderboard.css' %}">
{% endblock %}

{% block content %}
<!-- Classroom Header -->
<div class="dashboard-header animate-fade-in">
    <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
            <h1><i class="fas fa-users"></i> {{ classroom.name }}</h1>
            <p>{{ classroom.description }}</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            {% if user.is_staff %}
            <!-- Mentor Actions -->
            <button class="btn-modern btn-primary">
                <i class="fas fa-plus"></i> Add Challenge
            </button>
            <button class="btn-modern btn-secondary">
                <i class="fas fa-cog"></i> Settings
            </button>
            <button class="btn-modern btn-secondary">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            {% else %}
            <!-- Student Actions -->
            {% if request.user.is_authenticated %}
            {% if is_member %}
            <form method="POST" action="{% url 'leave_classroom' classroom.slug %}" style="margin: 0;">
                {% csrf_token %}
                <button class="btn-modern"
                    style="background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid var(--error);">
                    <i class="fas fa-sign-out-alt"></i> Leave Classroom
                </button>
            </form>
            {% else %}
            <form method="POST" action="{% url 'join_classroom' classroom.slug %}" style="margin: 0;">
                {% csrf_token %}
                <button class="btn-modern btn-primary">
                    <i class="fas fa-user-plus"></i> Join Classroom
                </button>
            </form>
            {% endif %}
            {% endif %}
            {% endif %}
            <a href="/classrooms/" class="btn-modern btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Classrooms
            </a>
        </div>
    </div>
</div>

<!-- Classroom Info Cards -->
<div class="stats-grid animate-fade-in">
    <div class="stat-card">
        <div class="stat-card-icon primary">
            <i class="fas fa-user-tie"></i>
        </div>
        <div class="stat-card-value">{{ classroom.mentor.username }}</div>
        <div class="stat-card-label">Instructor</div>

    </div>

    <div class="stat-card">
        <div class="stat-card-icon success">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-card-value">{{ members_count }}</div>
        <div class="stat-card-label">Members</div>
    </div>

    <div class="stat-card">
        <div class="stat-card-icon warning">
            <i class="fas fa-code"></i>
        </div>
        <div class="stat-card-value">{{ challenges_count }}</div>
        <div class="stat-card-label">Challenges</div>
    </div>

    {% if user.is_staff %}
    <!-- Mentor-specific stat -->
    <div class="stat-card">
        <div class="stat-card-icon info">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-card-value">78%</div>
        <div class="stat-card-label">Avg. Completion</div>
    </div>
    {% else %}
    <!-- Student-specific stat -->
    <div class="stat-card">
        <div class="stat-card-icon info">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-card-value">67%</div>
        <div class="stat-card-label">Your Progress</div>
    </div>
    {% endif %}
</div>

<!-- Announcements -->
<div class="section-header">
    <h2><i class="fas fa-bullhorn"></i> Announcements</h2>
    {% if user.is_staff %}
    <button class="btn-modern btn-primary" style="padding: 0.5rem 1rem;">
        <i class="fas fa-plus"></i> Post Announcement
    </button>
    {% endif %}
</div>

<!-- <div class="card-modern animate-fade-in" style="margin-bottom: 2rem;">
    <div
        style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
        <div style="flex: 1;">
            <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">
                <i class="fas fa-info-circle" style="color: var(--primary-500);"></i>
                Welcome to Python Fundamentals!
            </h4>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin: 0;">
                <i class="fas fa-clock"></i> Posted 2 days ago by Prof. Johnson
            </p>
        </div>
    </div>
    <p style="color: var(--text-secondary); margin: 0;">
        Welcome everyone! We'll be covering Python basics, data structures, and algorithms. Make sure to complete all
        challenges and participate in discussions. Good luck!
    </p>
</div> -->

<!-- Challenges List -->
<div class="section-header">
    <h2><i class="fas fa-code"></i> Challenges</h2>
    <span class="badge-modern badge-primary">
        {{ completed_count|default:0 }} / {{ challenges_count }} Completed
    </span>
</div>

<div class="challenge-list animate-fade-in">
    {% for item in challenge_entries %}
    {% with challenge=item.challenge status=item.status %}
    <div class="challenge-item" onclick="window.location.href='{% url 'challenge_detail' challenge.slug %}'">
        <div class="challenge-info">
            <div class="challenge-title">{{ challenge.title }}</div>
            <div class="challenge-meta">
                <span class="badge-modern badge-{{ challenge.difficulty }}">
                    <i class="fas fa-circle"></i> {{ challenge.get_difficulty_display }}
                </span>
                {% if challenge.tags.all %}
                <span style="color: var(--text-secondary); font-size: 0.875rem;">
                    <i class="fas fa-tags"></i>
                    {% for tag in challenge.tags.all %}
                    {{ tag.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </span>
                {% endif %}
            </div>
        </div>

        <div class="challenge-actions">
            {% if user.is_staff %}
            <!-- Mentor View: Show completion stats and management buttons -->
            <span class="badge-modern badge-success">
                <i class="fas fa-users"></i> {{ item.completed_count|default:0 }}/{{ members_count }} Completed
            </span>
            <button class="btn-modern btn-secondary" style="padding: 0.5rem 1rem;" onclick="event.stopPropagation();">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn-modern"
                style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid var(--error);"
                onclick="event.stopPropagation();">
                <i class="fas fa-trash"></i>
            </button>
            {% else %}
            <!-- Student View: Show status and action buttons -->
            {% if status == "passed" %}
            <span class="badge-modern" style="background-color: rgba(16, 185, 129, 0.1); color: var(--success);">
                <i class="fas fa-check-circle"></i> Passed
            </span>
            <button class="btn-modern btn-secondary"
                onclick="event.stopPropagation(); window.location.href='{% url 'challenge_detail' challenge.slug %}'">
                <i class="fas fa-eye"></i> View
            </button>

            {% elif status == "not_started" %}
            <span class="badge-modern" style="background-color: rgba(99, 102, 241, 0.1); color: var(--primary-500);">
                <i class="fas fa-circle"></i> Not Started
            </span>
            <button class="btn-modern btn-primary"
                onclick="event.stopPropagation(); window.location.href='{% url 'challenge_detail' challenge.slug %}'">
                <i class="fas fa-play"></i> Start
            </button>

            {% elif status == "in_progress" %}
            <span class="badge-modern" style="background-color: rgba(234, 179, 8, 0.1); color: #ca8a04;">
                <i class="fas fa-spinner"></i> In Progress
            </span>
            <button class="btn-modern btn-primary"
                onclick="event.stopPropagation(); window.location.href='{% url 'challenge_detail' challenge.slug %}'">
                <i class="fas fa-play"></i> Continue
            </button>

            {% elif status == "failed" %}
            <span class="badge-modern" style="background-color: rgba(248, 113, 113, 0.1); color: #ef4444;">
                <i class="fas fa-times-circle"></i> Failed
            </span>
            <button class="btn-modern btn-primary"
                onclick="event.stopPropagation(); window.location.href='{% url 'challenge_detail' challenge.slug %}'">
                <i class="fas fa-redo"></i> Retry
            </button>
            {% endif %}
            {% endif %}
        </div>
    </div>
    {% endwith %}
    {% empty %}
    <p>No challenges in this classroom yet.</p>
    {% endfor %}
</div>


<div class="row">
    <div class="col-md-8">
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-2">About this classroom</h4>
                <p class="card-text">
                    {{ classroom.description|default:"No description added yet." }}
                </p>
                <p class="card-text mb-0">
                    <strong>Created at:</strong>
                    {{ classroom.created_at|date:"M d, Y" }}
                </p>
            </div>
        </div>

        <!-- Student Progress / Leaderboard Section -->
        <div class="section-header" style="margin-top: 2rem;">
            {% if user.is_staff %}
            <h2><i class="fas fa-chart-line"></i> Student Progress</h2>
            <button class="btn-modern btn-secondary" style="padding: 0.5rem 1rem;">
                <i class="fas fa-download"></i> Export Report
            </button>
            {% else %}
            <h2><i class="fas fa-trophy"></i> Classroom Leaderboard</h2>
            <a href="/leaderboard/">
                View Global <i class="fas fa-arrow-right"></i>
            </a>
            {% endif %}
        </div>

        <div class="leaderboard-table-container animate-fade-in">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Student</th>
                        <th>Solved</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="rank-cell top-3">1</td>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                                </div>
                                <div class="user-info">
                                    <div class="user-name"></div>
                                </div>
                            </div>
                        </td>
                        <td></td>
                        <td class="points-cell"></td>
                    </tr>

                </tbody>
            </table>
        </div>

        {% endblock %}